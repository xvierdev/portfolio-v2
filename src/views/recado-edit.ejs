<div id="feedback-message" style="padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; display: none;">
</div>

<section class="contato-section">
    <h3>Editando Recado #<%= recado.id %></h3>

    <form id="form-editar-recado" class="recado-form">
        <input type="hidden" id="recado-id" value="<%= recado.id %>">

        <div class="form-group">
            <label for="nome">Seu Nome:</label>
            <input type="text" id="nome" name="nome" value="<%= recado.nome %>" required>
        </div>
        <div class="form-group">
            <label for="mensagem">Sua Mensagem:</label>
            <textarea id="mensagem" name="mensagem" rows="4" required><%= recado.mensagem %></textarea>
        </div>

        <button type="submit" class="btn-contato">Salvar Altera√ß√µes</button>
        <a href="/recados" class="btn-cancel">Cancelar</a>
    </form>
</section>

<script>
    const formEditarRecado = document.getElementById('form-editar-recado');
    const recadoIdInput = document.getElementById('recado-id');
    const nomeInput = document.getElementById('nome');
    const mensagemTextarea = document.getElementById('mensagem');
    const feedbackMessage = document.getElementById('feedback-message');
    const API_URL = '/api/recados';

    // --- FUN√á√ÉO PARA EXIBIR FEEDBACK ---
    function exibirFeedback(mensagem, tipo = 'success') {
        feedbackMessage.textContent = mensagem;
        feedbackMessage.style.display = 'block';

        // Defini√ß√£o das cores de feedback
        if (tipo === 'success') {
            feedbackMessage.style.backgroundColor = '#d4edda';
            feedbackMessage.style.borderColor = '#c3e6cb';
            feedbackMessage.style.color = '#155724';
        } else if (tipo === 'error') {
            feedbackMessage.style.backgroundColor = '#f8d7da';
            feedbackMessage.style.borderColor = '#f5c6cb';
            feedbackMessage.style.color = '#721c24';
        } else if (tipo === 'info') { // Adicionando estilo para a mensagem 'Salvando...'
            feedbackMessage.style.backgroundColor = '#cfe2ff';
            feedbackMessage.style.borderColor = '#b8daff';
            feedbackMessage.style.color = '#004085';
        }

        // Esconde a mensagem ap√≥s 5 segundos, *exceto* se for sucesso (pois o redirecionamento far√° isso)
        if (tipo !== 'success') {
            setTimeout(() => {
                feedbackMessage.style.display = 'none';
            }, 5000);
        }
    }

    // --- EVENT LISTENER PARA ATUALIZAR RECADO (PUT) ---
    formEditarRecado.addEventListener('submit', async (e) => {
        e.preventDefault();

        const recadoId = recadoIdInput.value;
        const nome = nomeInput.value;
        const mensagem = mensagemTextarea.value;

        exibirFeedback('Salvando altera√ß√µes...', 'info');

        try {
            const response = await fetch(`${API_URL}/${recadoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome,
                    mensagem
                })
            });

            // üöÄ MUDAN√áA: Verificamos o sucesso (200-299) antes de tentar ler o JSON.
            if (response.ok) { // response.ok √© true para status 200-299
                exibirFeedback('Recado atualizado com sucesso! Redirecionando...', 'success');

                // A L√ìGICA DE REDIRECIONAMENTO CORRETA
                setTimeout(() => {
                    window.location.href = '/recados'; // Redireciona para a lista
                }, 2000); // Espera 2 segundos (2000ms)

                return; // Encerra a execu√ß√£o da fun√ß√£o aqui
            }

            // Se n√£o foi sucesso (response.ok √© false), tentamos ler o JSON de erro
            const data = await response.json();
            // Se o corpo n√£o for JSON (ex: 500), esta linha vai para o catch.

            if (response.status === 400) { // 400 Bad Request
                exibirFeedback(`Erro de valida√ß√£o: ${data.mensagem}`, 'error');
            } else if (response.status === 404) { // 404 Not Found
                exibirFeedback(`Erro: ${data.mensagem}`, 'error');
            } else {
                exibirFeedback(`Erro desconhecido: Status ${response.status}`, 'error');
            }
        } catch (error) {
            // O erro pode ser de rede OU falha ao tentar ler o JSON de erro do servidor
            exibirFeedback('Erro de rede ou falha na comunica√ß√£o com o servidor. Tente novamente.', 'error');
            console.error('Erro detalhado:', error); // Adiciona um log no console para debug
        }
    });
</script>